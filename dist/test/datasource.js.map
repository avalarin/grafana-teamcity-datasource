{"version":3,"sources":["../../src/datasource.js"],"names":["TeamCityDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","withCredentials","headers","basicAuth","length","targetTypes","fields","build","getBuildTypes","then","status","message","title","target","query","indexOf","Promise","reject","types","filter","id","map","text","value","options","promises","targets","queryOneTarget","all","data","concat","apply","results","queryOptions","field","getBuilds","buildType","count","maxDataPoints","from","range","to","mapResult","builds","items","datapoints","item","date","sort","a","b","request","encodeURIComponent","format","escapeBuildTypeId","parseInt","doRequest","method","result","number","statusText","finishDate","unix","projectName","projectId","datasourceRequest","replace"],"mappings":"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","file":"datasource.js","sourcesContent":["import moment from 'moment'\n\nexport class TeamCityDatasource {\n\n    constructor(instanceSettings, $q, backendSrv, templateSrv) {\n        this.type = instanceSettings.type;\n        this.url = instanceSettings.url;\n        this.name = instanceSettings.name;\n        this.q = $q;\n        this.backendSrv = backendSrv;\n        this.templateSrv = templateSrv;\n        this.withCredentials = instanceSettings.withCredentials;\n        this.headers = {'Content-Type': 'application/json'};\n        if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\n          this.headers['Authorization'] = instanceSettings.basicAuth;\n        }\n\n        this.targetTypes = [ 'build' ]\n        this.fields = {\n            build: [ 'status', 'statusText', 'number', 'name', 'projectName' ]\n        }\n      }\n\n    testDatasource() {\n        return this.getBuildTypes()\n            .then(() => ({ status: 'success', message: 'Data source is working', title: 'Success' }))\n    }\n\n    metricFindQuery(target, query) {\n        if (this.targetTypes.indexOf(target.type) == -1) {\n            return Promise.reject({ status: 'error', message: `metricFindQuery: Unknown target type ${target.type}` })\n        }\n        if (target.type == 'build') {\n            return this.getBuildTypes().then(types =>\n                types\n                    .filter(type => type.id.indexOf(query) != -1)\n                    .map(type => ({ text: type.id, value: type.id }))\n            )\n        }\n        return Promise.reject({ status: 'error', message: `metricFindQuery: Unexpected state` })\n    }\n\n    query(options) {\n        var promises = options.targets\n            .map(target => this.queryOneTarget(options, target))\n        \n        return Promise.all(promises).then(results => ({ data: [].concat.apply([], results) }))\n    }\n\n    async queryOneTarget(queryOptions, target) {\n        if (this.targetTypes.indexOf(target.type) == -1) {\n            return Promise.reject({ status: 'error', message: `queryOneTarget: Unknown target type ${target.type}` })\n        }\n        if (this.fields[target.type].indexOf(target.field) == -1) {\n            return Promise.reject({ status: 'error', message: `queryOneTarget: Unknown field ${target.field}` })\n        }\n        if (target.type == 'build') {\n            return this.getBuilds({\n                buildType: target.target,\n                count: queryOptions.maxDataPoints,\n                from: queryOptions.range.from,\n                to: queryOptions.range.to\n            }).then(builds => this.mapResult(target, builds))\n        }\n        return Promise.reject({ status: 'error', message: `queryOneTarget: Unexpected state` })\n    }\n\n    mapResult(target, items) {\n        return { \n            target: target.target,\n            datapoints: items.map(item => [item[target.field], item.date])\n                              .sort((a, b) => a[1] > b[1])\n        }\n    }\n\n    getBuilds(request) {\n        var from = encodeURIComponent(moment(request.from).format(\"YYYYMMDDTHHmmssZ\"))\n        var to = encodeURIComponent(moment(request.to).format(\"YYYYMMDDTHHmmssZ\"))\n        var url = `${this.url}/httpAuth/app/rest/builds?`\n            + `locator=buildType:(${escapeBuildTypeId(request.buildType)}),count:${parseInt(request.count)},`\n            + `finishDate:(date:${from},condition:after),finishDate:(date:${to},condition:before)&`\n            + 'fields=build(number,status,statusText,finishDate,buildType(name,projectName))'\n        return this.doRequest({\n            url: url,\n            method: 'GET'\n        }).then(result => {\n            return result.data.build.map(build => ({\n                number: build.number,\n                status: build.status == 'SUCCESS' ? 100 : 0,\n                statusText: build.statusText,\n                date: moment(build.finishDate, 'YYYYMMDDTHHmmssZ').unix() * 1000,\n                name: build.buildType.name,\n                projectName: build.buildType.projectName\n            }))\n        })\n    }\n\n    getBuildTypes() {\n        var url = `${this.url}/httpAuth/app/rest/buildTypes?fields=buildType(id,name,projectName,projectId)`\n        return this.doRequest({\n            url: url,\n            method: 'GET'\n        }).then(result => {\n            return result.data.buildType.map(type => ({\n                id: type.id,\n                name: type.name,\n                projectId: type.projectId,\n                projectName: type.projectName\n            }))\n        })\n    }\n\n    doRequest(options) {\n        options.withCredentials = this.withCredentials;\n        options.headers = this.headers;\n    \n        return this.backendSrv.datasourceRequest(options)\n      }\n\n}\n\nfunction escapeBuildTypeId(id) {\n    return id.replace(/[^a-zA-Z0-9_]+/g,'_')\n}"]}